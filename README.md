# はじめに

- 本プロジェクトは、 Docker で運用しているアプリケーションのデータをバックアップ・リストアするツールを管理している。
  - docker の volume と、通常のファイル・フォルダがバックアップ対象

# バックアップ運用

## 前提

- sshpass コマンドをインストールしていること
- visudo で 下記を追記し、 sudo tar 実行によりパスワードを求められないようにすること
  `<ユーザー名> ALL=(ALL:ALL) NOPASSWD: /bin/tar`

## バックアップ方法

### 手動バックアップ（コマンド実行バックアップ）
1. `backup-tool` ディレクトリに移動
2. `sudo bash ./backup.sh` を実行
3. 転送先フォルダに期待通りに配置されているか確認する。

### 自動定期バックアップ

1. 一般ユーザーで `crontab　-e` を実行
2. 設定ファイルに下記を記載
   ※パスは適宜修正すること
   ```
   */3 * * * * cd /home/user/someapp/backup-tool  &&  bash ./backup.sh
   ```
3. `crontab -l` で確認
4. 期待通りであれば、`*/3 * * * *` を `0 1 * * *` （毎日午前1時）などに設定し、正式運用を開始する。

## リストア方法

1. バックアップ資材を入手する。`backup.sh`により出力された tar.gz ファイルを想定。内容は、コンテナ内にマウントしているリソースのバックアップである。

2. [1.] の資材を `data/` フォルダにコピーする。

3. `.backup-tool.env` の内容を確認・修正する。
   - BKUP_PREFIX
     - `/var/lib/docker/volumes`配下にはボリュームに対応するフォルダが作成されている。
     - 各フォルダ名は、`<1.バックアップ時に conpose.yml が配置されていたフォルダ名><2.compose.yml 上の volume 名>` という形式となっており、`<1.>`の名前を `BKUP_PREFIX` の値とする。
     - 末尾のアンダースコアを忘れないこと

4. 実行前の状態確認を下記コマンドを実行して行う。
   ```bash
   sudo ls -al /var/lib/docker/volumes
   ```

5. 下記を実行する。
   ```bash
   cd backup-tool
   bash ./restore.sh
   ```
   ※sudo 利用しているため、パスワードを求められるので対応すること。

6. 実行後の状態確認を下記コマンドを実行して行う。
   ```bash
   sudo ls -al /var/lib/docker/volumes
   ```

7. `docker compose up -d` コマンドで起動する。


# バックアップ運用用のためのスクリプト

## バックアップスクリプトの役割や機能

- 環境変数ファイルを読み込み、設定を適用する。
- 指定されたDockerボリュームとファイルをバックアップし、圧縮アーカイブとして保存する。
- バックアップファイルをリモートサーバに転送し、転送の成否を確認する。
- リモートサーバ上で古いバックアップを削除し、バックアップのローテーションを行う。
- バックアップ後、ローカルのバックアップファイルを削除し、元のディレクトリに戻る。

## リストアスクリプトの役割や機能

- 環境変数ファイルを読み込み、設定を適用する。
- 指定されたDockerボリュームとファイルの存在を確認し、既存のものがない場合に限りリストアを実行する。
- ボリュームデータやファイルを圧縮アーカイブから展開し、指定されたパスにリストアする。
- リストア処理中に使用するディレクトリに移動し、処理後に元のディレクトリに戻る。
- リストア処理の途中で問題が発生した場合、適切なエラーメッセージを表示して処理を中断する。

## 動作確認環境

- バックアップ元サーバ: `Ubuntu 22`
- 転送先サーバ: `FreeBSD 13.3-RELEASE-p2 be4f1894e GENERIC i386`
